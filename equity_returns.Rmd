---
title: "Equity Market Returns"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

# Equity Market Returns
## Load modules
```{r}
library(xlsx)
```

## Set workding directory
```{r}
setwd('/Users/gsarchioni/Desktop/Work/returns')
directory = getwd()
```

## Load dataset
```{r}
returns = read.xlsx('returns.xlsx', sheetIndex = 1)
names(returns)[15] <- 'X12month'
```


# Normality test
```{r}
shapiro_test <- data.frame(names(returns)[2:15],
                           'pvalue' = numeric(14))

# For-loop to calculate correlations. Add estimate and p-value to
# density_corr data frame.
for (i in 1:14) {
  shapiro_value <- shapiro.test(returns[,i+1])$p.value
  shapiro_test$pvalue[i] = shapiro_value
}
```
Shapiro test for all variables has a p-value below 5%, i.e. we can assume data is normally distributed.

# Add month data
```{r}
library(lubridate)
returns_new <- returns
returns_new$month <- month(returns_new$Date)
returns_new$month <- as.factor(returns_new$month)
returns_new$month_num <- as.numeric(returns_new$month)
returns_new$quarter <- with(returns_new,
                            ifelse(month_num <= 3, 'Q1',
                                   ifelse(month_num <= 6, 'Q2',
                                          ifelse(month_num <= 9, 'Q3','Q4'))))


# Assign levels to months
returns_new$month <- factor(returns_new$month,
                            levels = as.character(seq(1,12,1)))
```



# Charting functions
## Histogram
```{r}
# Function to draw histogram
plot_hist <- function(variable) {
  
  name = sub("X*", "", variable)
  title = paste(name, "- Histogram")
  
  ggplot(data = returns_new,
         aes_q(x = as.name(variable))) +
    geom_histogram(fill = 'blue',
                   colour = 'white') +
    labs(x = 'Return',
         y = "",
         title = title) +
    theme(panel.background = element_blank(),
          plot.title = element_text(face = 'bold',
                                    size = 12,
                                    margin = margin(5,0,10,0)),
          axis.ticks = element_blank(),
          axis.title.x = element_text(face = 'bold',
                                      size = 10,
                                      margin = margin(15,0,5,0)),
          axis.text.y = element_blank())
    
  
}
```

### Testing
```{r}
plot_hist('X2week')
```


## Distribution by quarter
```{r}
# Function to draw distribution by quarter
dist_quarter <- function(variable) {
  
  name = sub("X*", "", variable)
  title = paste(name, "- Boxplot by quarter")
  
  ggplot(data = returns_new,
         aes_q(x = returns_new$quarter,
               y = as.name(variable))) +
    geom_boxplot(outlier.size = 0.5) +
    scale_y_continuous(breaks = seq(round(min(returns_new[,variable])/5)*5,
                                    round(max(returns_new[,variable])/5)*5,
                                    5)) +
    labs(x = '',
         y = "Return",
         title = title) +
    theme(panel.background = element_blank(),
          panel.grid.major.y = element_line(colour = 'grey',
                                            size = 0.2),
          panel.grid.major.x = element_blank(),
          plot.title = element_text(face = 'bold',
                                    size = 12,
                                    margin = margin(5,0,10,0)),
          axis.text.x = element_text(margin = margin(15,0,5,0)),
          axis.ticks = element_blank())
}
```

### Testing
```{r}
dist_quarter('X2week')
```


## Distribution by month
```{r}
# Function to draw distribution by month
dist_month <- function(variable) {
  
  name = sub("X*", "", variable)
  title = paste(name, "- Boxplot by month")
  
  labels = month.abb[as.numeric(levels(returns_new$month))]
  
  ggplot(data = returns_new,
         aes_q(x = returns_new$month,
               y = as.name(variable))) +
    geom_boxplot(outlier.size = 0.5) +
    scale_y_continuous(breaks = seq(round(min(returns_new[,variable])/5)*5,
                                    round(max(returns_new[,variable])/5)*5,
                                    5)) +
    scale_x_discrete(labels = labels) +
    labs(x = '',
         y = "Return",
         title = title) +
    theme(panel.background = element_blank(),
          panel.grid.major.y = element_line(colour = 'grey',
                                            size = 0.2),
          panel.grid.major.x = element_blank(),
          plot.title = element_text(face = 'bold',
                                    size = 12,
                                    margin = margin(5,0,10,0)),
          axis.text.x = element_text(margin = margin(15,0,5,0)),
          axis.ticks = element_blank())
}
```

### Testing
```{r}
dist_month('X2week')
```


## Normal distribution cumulative estimator
```{r}
# Function to create probability estimator
prob_estimator <- function(variable) {
  ret_values = c(1, 2.5, 5, 7.5, 10,
                 12.5, 15, 20, 25, 30)
  prob_table = data.frame(ret_values,
                        'probability' = numeric(10),
                        'axis' = numeric(10))

  mean_variable = mean(returns_new[,variable])
  std_variable = sd(returns_new[,variable])
  
  prob_table$axis <- 1
  
  for (i in 1:10) {
    probability = pnorm(ret_values[i],
                        mean = mean_variable,
                        sd = std_variable,
                        lower.tail = FALSE,
                        log.p = FALSE)
    
    prob_table$probability[i] <- probability * 100
  }
  
  return(prob_table)
  
}
```

## Probability Plot
```{r}
plot_prob <- function(variable) {
  
  # Retrieve prob_table estimator
  prob_table = prob_estimator(variable)
  
  title = paste(sub("X*", "", variable),
                "- Cumulative probability (return greater than)")
  
  ggplot(data = prob_table,
         aes(x = ret_values,
             y = probability)) +
  scale_y_continuous(breaks = seq(0,
                                  round(max(prob_table$probability)/5)*5,
                                  5)) +
  scale_x_continuous(breaks = c(1,
                                seq(2.5,15,2.5),
                                seq(20,30,5))) +
  geom_line(data = prob_table,
              colour = 'blue',
              size = 0.8, alpha = 1/2) +
  geom_point(size = 2,
             stroke = 0.8,
             pch = 21,
             fill = 'white',
             colour = 'blue') +
  labs(x = 'Return',
       y = 'Probability',
       title = title) +
  theme(panel.background = element_blank(),
        panel.grid.major.x = element_line(colour = 'grey',
                                          size = 0.2),
        panel.grid.major.y = element_line(colour = 'grey',
                                          size = 0.2),
        plot.title = element_text(face = 'bold',
                                  size = 12,
                                  margin = margin(5,0,10,0)),
        axis.ticks = element_blank(),
        axis.title.y = element_text(face = 'bold',
                                  size = 10,
                                  margin = margin(0,15,0,5)),
        axis.title.x = element_text(face = 'bold',
                                  size = 10,
                                  margin = margin(15,0,5,0)))
}
```

```{r}
plot_prob('X2week')
```


# Plotting and saving function
```{r}
plot_n_save <- function(variable) {
  
  name = sub("X*", "", variable)
  filename = paste(name,
                   '.png',
                   sep = '')
  
  # All charts
  h <- plot_hist(variable)
  d_q <- dist_quarter(variable)
  d_m <- dist_month(variable)
  prob <- plot_prob(variable)
  
  # Arrange in a Grob object
  grob <- arrangeGrob(h,
                      d_q,
                      d_m,
                      prob,
                      nrow = 2,
                      ncol = 2)
  
  # Save
  ggsave(filename = filename,
         grob,
         width = 18,
         height = 12,
         scale = 0.8,
         dpi = 800)
  
}
```

# Final code
```{r}
for (i in 2:15) {
  plot_n_save(names(returns_new)[i])
}
```

